name: Android Nightly Debug Build

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write 

    steps:
      - name: â¬‡ï¸ Checkout of code
        uses: actions/checkout@v4
        with:
          submodules: recursive
        
      - name: ðŸ› ï¸ Java and Android SDK Setup
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: âš™ï¸ Setup of Gradle Wrapper
        uses: gradle/actions/setup-gradle@v3

      # --- Build Phase ---
      - name: ðŸ—ï¸ Running the Debug Build (only Nightly)
        run: ./gradlew assembleDebug

      # --- Extraction Phase ---
      - name: ðŸ“¦ Find the path to the Debug APK
        id: find_apk
        run: |
          # More flexible recursive search across the entire build folder
          APK_DEBUG_PATH=$(find ${{ github.workspace }}/app/build -type f -name "*debug.apk" -print -quit)
          
          if [ -z "$APK_DEBUG_PATH" ]; then
            echo "CRITICAL ERROR: Debug APK not found in app/build. Check build step logs."
            exit 1 # Fails if APK is not found
          fi
          echo "APK_PATH_ENV=$APK_DEBUG_PATH" >> $GITHUB_ENV
          echo "DEBUG_PATH: $APK_DEBUG_PATH"

      
      - name: ðŸ”Ž Get Package Name and Version (Using aapt)
        id: package_info
        run: |
          # Referencing the APK path via environment variable
          APK_FILE="APK_PATH_ENV"

          if [ -z "$APK_FILE" ]; then
            echo "CRITICAL ERROR: APK_PATH_ENV is empty. Find step failed."
            exit 1
          fi
          
          # Extract info using aapt dump badging
          AAPT_OUTPUT=$(aapt dump badging "$APK_FILE")
          
          # Extract Package Name and Version Name from aapt output
          PACKAGE_NAME=$(echo "$AAPT_OUTPUT" | grep 'package: name' | awk -F"'" '{print $2}')
          VERSION_NAME=$(echo "$AAPT_OUTPUT" | grep 'versionName=' | awk -F"'" '{print $4}')
          
          if [ -z "$PACKAGE_NAME" ] || [ -z "$VERSION_NAME" ]; then
            echo "CRITICAL ERROR: Failed to extract package or version name using aapt."
            echo "AAPT Output: $AAPT_OUTPUT"
            exit 1
          fi

          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "Extracted Package Name: $PACKAGE_NAME"
          echo "Extracted Version Name: $VERSION_NAME"

      - name: ðŸ·ï¸ Defining the Release Tag and Title
        id: release_vars
        run: |
          # Formato YYYYMMDD-HHMM
          DATE_TIME=$(date -u +%Y%m%d-%H%M)
          VERSION_NAME="${{ steps.package_info.outputs.VERSION_NAME }}"
          PACKAGE_NAME="${{ steps.package_info.outputs.PACKAGE_NAME }}"

          # Tag: com.nanodata.armsx2-nightly-1.0.4-20251104-1411
          TAG="${PACKAGE_NAME}-nightly-${VERSION_NAME}-${DATE_TIME}"
          TITLE="Nightly Build (DEBUG - ${VERSION_NAME}) - ${DATE_TIME}"
          
          echo "RELEASE_TAG=$TAG" >> $GITHUB_OUTPUT
          echo "RELEASE_TITLE=$TITLE" >> $GITHUB_OUTPUT

      # --- Release Phase ---
      - name: âœï¸ Rename the APK to *-nightly.apk
        id: rename_apk
        run: |
          ORIGINAL_PATH="$APK_PATH_ENV"
          
          if [ -z "$ORIGINAL_PATH" ]; then
            echo "CRITICAL ERROR: APK path not found in environment variable. Cannot rename."
            exit 1
          fi

          PACKAGE_NAME="${{ steps.package_info.outputs.PACKAGE_NAME }}"
          VERSION_NAME="${{ steps.package_info.outputs.VERSION_NAME }}"
          DATE_TIME=$(date -u +%Y%m%d-%H%M)

          NEW_FILE_NAME="${PACKAGE_NAME}-${VERSION_NAME}-nightly-${DATE_TIME}.apk"
          NIGHTLY_PATH="$(dirname "$ORIGINAL_PATH")/$NEW_FILE_NAME"

          if [ -f "$ORIGINAL_PATH" ]; then
            mv "$ORIGINAL_PATH" "$NIGHTLY_PATH"
          else
            echo "CRITICAL ERROR: The original APK file was not found at path: $ORIGINAL_PATH"
            exit 1
          fi

          echo "APK_FILE=$NIGHTLY_PATH" >> $GITHUB_OUTPUT
          echo "NIGHTLY_PATH: $NIGHTLY_PATH"

      - name: ðŸš€ Create the Release on GitHub
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.release_vars.outputs.RELEASE_TAG }}
          name: ${{ steps.release_vars.outputs.RELEASE_TITLE }}
          body: |
            ## Automatic Night Release (DEBUG)
            
            Automated build for community testing. This is an **unsigned** build for public distribution.
            
            * **Version:** ${{ steps.package_info.outputs.VERSION_NAME }}
            * **Package Name:** ${{ steps.package_info.outputs.PACKAGE_NAME }}
            * **Branch:** ${{ github.ref_name }}
            * **Commit:** ${{ github.sha }}
            
            **Check the attached assets for the NIGHTLY APK.**
          draft: false
          prerelease: true
          files: ${{ steps.rename_apk.outputs.APK_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}