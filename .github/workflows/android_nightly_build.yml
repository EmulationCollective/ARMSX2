name: Android Nightly Debug Build

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:

jobs:
  build_and_release:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write 

    steps:
      - name: â¬‡ï¸ Checkout of code
        uses: actions/checkout@v4
        with:
          submodules: recursive
        
      - name: ðŸ› ï¸ Java and Android SDK Setup
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: âš™ï¸ Setup of Gradle Wrapper
        uses: gradle/actions/setup-gradle@v3

      # --- Build Phase ---
      - name: ðŸ—ï¸ Running the Debug Build (only Nightly)
        run: ./gradlew assembleDebug

      # --- Extraction Phase ---
      - name: ðŸ“¦ Find the path to the Debug APK
        id: find_apk
        run: |
          # More flexible recursive search across the entire build folder
          APK_DEBUG_PATH=$(find ${{ github.workspace }}/app/build -type f -name "*debug.apk" -print -quit)
          
          if [ -z "$APK_DEBUG_PATH" ]; then
            echo "CRITICAL ERROR: Debug APK not found in app/build. Check build step logs."
            exit 1 # Fails if APK is not found
          fi
          echo "APK_PATH_ENV=$APK_DEBUG_PATH" >> $GITHUB_ENV
          echo "DEBUG_PATH: $APK_DEBUG_PATH"

      # --- Release Phase ---
      - name: âœï¸ Rename the APK to *-nightly.apk
        id: rename_apk
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PACKAGE_NAME="com.nanodata.armsx2"
          LATEST_RELEASE_TAG=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases/latest" | \
            jq -r '.tag_name')
          if [ -z "$LATEST_RELEASE_TAG" ] || [ "$LATEST_RELEASE_TAG" == "null" ]; then
            echo "WARNING: No stable release tag found. I'm using the fallback version (0.0.0).."
            VERSION_NAME="0.0.0"
          else
            VERSION_NAME=$(echo "$LATEST_RELEASE_TAG" | sed 's/^v//')
          fi
          ORIGINAL_PATH="${{ steps.find_apk.outputs.APK_FILE_PATH }}"
          
          if [ -z "$ORIGINAL_PATH" ]; then
            echo "CRITICAL ERROR: APK path not found in environment variable. Cannot rename."
            exit 1
          fi

          DATE_TIME=$(date -u +%Y%m%d-%H%M)
          NEW_FILE_NAME="nightly-${DATE_TIME}.apk"

          NEW_FILE_NAME="${PACKAGE_NAME}-nightly-${VERSION_NAME}-${DATE_TIME}.apk"
          NIGHTLY_PATH="$(dirname "$ORIGINAL_PATH")/$NEW_FILE_NAME"

          if [ -f "$ORIGINAL_PATH" ]; then
            mv "$ORIGINAL_PATH" "$NIGHTLY_PATH"
          else
            echo "CRITICAL ERROR: The original APK file was not found at the path: $ORIGINAL_PATH"
            exit 1
          fi

          echo "APK_FILE=$NIGHTLY_PATH" >> $GITHUB_OUTPUT
          echo "New route Nightly: $NIGHTLY_PATH"

          TAG="${PACKAGE_NAME}-nightly-${VERSION_NAME}-${DATE_TIME}"
          TITLE="Nightly Build (DEBUG - ${VERSION_NAME}) - ${DATE_TIME}"

          echo "RELEASE_TAG=$TAG" >> $GITHUB_OUTPUT
          echo "RELEASE_TITLE=$TITLE" >> $GITHUB_OUTPUT
          echo "VERSION_NAME=$VERSION_NAME" >> $GITHUB_OUTPUT
          echo "PACKAGE_NAME=$PACKAGE_NAME" >> $GITHUB_OUTPUT

      - name: ðŸš€ Create the Release on GitHub
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.rename_apk.outputs.RELEASE_TAG }}
          name: ${{ steps.rename_apk.outputs.RELEASE_TITLE }}
          body: |
            ## Automatic Night Release (DEBUG)
            
            Automated build for community testing. This is an **unsigned** build for public distribution.
            
            * **Version:** ${{ steps.rename_apk.outputs.VERSION_NAME }}
            * **Package Name:** ${{ steps.rename_apk.outputs.PACKAGE_NAME }}
            * **Branch:** ${{ github.ref_name }}
            * **Commit:** ${{ github.sha }}
            
            **Check the attached assets for the NIGHTLY APK.**
          draft: false
          prerelease: true
          files: ${{ steps.rename_apk.outputs.APK_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}